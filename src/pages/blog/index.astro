---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Hero from '../../components/Hero.astro';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const allTags = [...new Set(posts.flatMap(post => post.data.tags || []))].sort();

const title = "Ultraviolet Blog";
const description = "Latest news, updates, and insights from the Ultraviolet team on confidential computing and secure AI.";
---

<Layout title={title} description={description}>
	<Header slot="header" />

    <div class="pt-0">
        <Hero 
            title="Ultraviolet Blog"
            description="Technical articles, product updates, and engineering deep dives from the Ultraviolet team on building open-source confidential computing & secure AI Platforms."
            alignment="center"
        />
    </div>

	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search and Filter Section -->
        <div class="mb-12 space-y-6">
            <div class="relative w-full">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search blogs..." 
                    class="w-full px-4 py-3 rounded-lg border border-border bg-surface text-text-main focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                    aria-label="Search blogs"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-text-muted">
                    <i class="fas fa-search" aria-hidden="true"></i>
                </div>
            </div>

            <div class="flex flex-wrap gap-2 mt-4 gap-y-2" id="categoryFilters">
                <button 
                    class="category-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-primary text-white" 
                    data-category="all"
                    aria-label="Filter by all categories"
                >
                    All
                </button>
                {allTags.map(tag => (
                    <button 
                        class="category-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-surface border border-border text-text-muted hover:bg-gray-100 dark:hover:bg-gray-800"
                        data-category={tag}
                        aria-label={`Filter by category ${tag}`}
                    >
                        {tag}
                    </button>
                ))}
            </div>
        </div>

		<div class="grid gap-16 lg:grid-cols-3 lg:gap-x-5 lg:gap-y-12" id="blogGrid">
			{
				posts.map((post) => (
					<div 
                        class="blog-card flex flex-col rounded-lg shadow-lg overflow-hidden transition-transform hover:-translate-y-1 border border-border bg-card"
                        data-title={post.data.title.toLowerCase()}
                        data-tags={post.data.tags?.join(',').toLowerCase() || ''}
                        data-excerpt={(post.data.excerpt || post.data.description || '').toLowerCase()}
                    >
						{post.data.image && (
                            <div class="flex-shrink-0">
                                <img class="h-48 w-full object-cover" src={post.data.image} alt={post.data.title} />
                            </div>
                        )}
						<div class="flex-1 bg-card p-6 flex flex-col justify-between">
							<div class="flex-1">
                                {post.data.tags && (
                                    <div class="flex flex-wrap gap-2 text-sm font-medium mb-2">
                                        {post.data.tags.map(tag => (
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                )}
								<a href={`/blog/${post.slug}`} class="block mt-2" aria-label={`Read more about ${post.data.title}`}>
									<p class="text-xl text-text-main font-heading">{post.data.title}</p>
									<p class="mt-3 text-base text-text-muted line-clamp-3">{post.data.excerpt || post.data.description}</p>
								</a>
							</div>
							<div class="mt-6 flex items-center">
                                {post.data.author && post.data.author.picture && (
                                    <div class="flex-shrink-0">
                                        <a href="#" aria-label={`View profile of ${post.data.author.name}`}>
                                            <span class="sr-only">{post.data.author.name}</span>
                                            <img class="h-10 w-10 rounded-full" src={post.data.author.picture} alt={`Picture of ${post.data.author.name}`} />
                                        </a>
                                    </div>
                                )}
								<div class="ml-3">
                                    {post.data.author && (
									    <p class="text-sm font-medium text-text-main">
										    <a href="#" class="hover:underline">{post.data.author.name}</a>
									    </p>
                                    )}
									<div class="flex space-x-1 text-sm text-text-muted">
										<time datetime={post.data.date.toISOString()}>
											{post.data.date.toLocaleDateString('en-US', {
												year: 'numeric',
												month: 'long',
												day: 'numeric',
											})}
										</time>
                                        <span aria-hidden="true">&middot;</span>
                                        <span>{Math.ceil(post.body.split(/\s+/).length / 200)} min read</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
	</div>

	<Footer slot="footer" />

    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const categoryButtons = document.querySelectorAll('.category-btn');
            const blogCards = document.querySelectorAll('.blog-card');
            let currentCategory = 'all';

            function filterPosts() {
                const searchTerm = searchInput.value.toLowerCase().trim();

                blogCards.forEach(card => {
                    const title = card.dataset.title;
                    const tags = card.dataset.tags;
                    const excerpt = card.dataset.excerpt;
                    const matchesSearch = title.includes(searchTerm) || tags.includes(searchTerm) || excerpt.includes(searchTerm);
                    const matchesCategory = currentCategory === 'all' || tags.split(',').includes(currentCategory.toLowerCase());

                    if (matchesSearch && matchesCategory) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filterPosts);

            categoryButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    categoryButtons.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-surface', 'text-text-muted');
                    });
                    btn.classList.remove('bg-surface', 'text-text-muted');
                    btn.classList.add('bg-primary', 'text-white');

                    currentCategory = btn.dataset.category;
                    filterPosts();
                });
            });

            // Check URL params for category
            const params = new URLSearchParams(window.location.search);
            const categoryFromURL = params.get('category');
            if (categoryFromURL) {
                const btn = document.querySelector(`.category-btn[data-category="${categoryFromURL}"]`);
                if (btn) btn.click();
            }
        });
    </script>
</Layout>
